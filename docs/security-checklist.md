# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã‚¹ãƒãƒ¼ãƒˆãƒ¬ã‚·ãƒ”ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–çŠ¶æ³ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

---

## âœ… ç’°å¢ƒå¤‰æ•°ç®¡ç†

### å®Ÿè£…çŠ¶æ³

- [x] `.gitignore`ã«`.env*.local`ã¨`.env`ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [x] `.env.example`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ãŠã‚Šã€å®Ÿéš›ã®ã‚­ãƒ¼ã¯å«ã¾ã‚Œã¦ã„ãªã„
- [x] APIã‚­ãƒ¼ã¯`process.env`ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹
- [x] ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨ã®APIã‚­ãƒ¼ã«`NEXT_PUBLIC_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

### ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°

| å¤‰æ•°å | ç”¨é€” | å…¬é–‹ç¯„å›² | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ« |
|--------|------|----------|------------------|
| `GEMINI_API_KEY` | AI ãƒ¬ã‚·ãƒ”ç”Ÿæˆ | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ | ğŸ”’ æ©Ÿå¯† |
| `SPOONACULAR_API_KEY` | æ—¢å­˜ãƒ¬ã‚·ãƒ”æ¤œç´¢ | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ | ğŸ”’ æ©Ÿå¯† |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabaseæ¥ç¶š | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ | ğŸ”“ å…¬é–‹ï¼ˆRLSã§ä¿è­·ï¼‰ |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabaseèªè¨¼ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¬é–‹ | ğŸ”“ å…¬é–‹ï¼ˆRLSã§ä¿è­·ï¼‰ |

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªé …ç›®

#### âœ… ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIã‚­ãƒ¼
- **ç¢ºèªç®‡æ‰€**:
  - `lib/gemini/client.ts:11` - `process.env.GEMINI_API_KEY`ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ï¼‰
  - `lib/recipe-api/spoonacular.ts:21` - `process.env.SPOONACULAR_API_KEY`ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ï¼‰

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
  - ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ«ã«ã¯å«ã¾ã‚Œãªã„
  - APIã‚­ãƒ¼ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¼æ´©ã—ãªã„

#### âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å…¬é–‹ã‚­ãƒ¼
- **ç¢ºèªç®‡æ‰€**:
  - `lib/supabase/client.ts:3-4` - `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
  - Supabase Anon Keyã¯å…¬é–‹ã‚’æƒ³å®šã—ãŸè¨­è¨ˆ
  - Row Level Security (RLS)ãƒãƒªã‚·ãƒ¼ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹
  - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã¯RLSã§é˜²å¾¡ã•ã‚Œã‚‹

---

## âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Row Level Security (RLS)

ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

#### favoritesãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

-- SELECTãƒãƒªã‚·ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãŠæ°—ã«å…¥ã‚Šã®ã¿é–²è¦§å¯èƒ½
CREATE POLICY "Users can view their own favorites"
ON favorites
FOR SELECT
USING (auth.uid() = user_id);

-- INSERTãƒãƒªã‚·ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãŠæ°—ã«å…¥ã‚Šã®ã¿è¿½åŠ å¯èƒ½
CREATE POLICY "Users can insert their own favorites"
ON favorites
FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- DELETEãƒãƒªã‚·ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãŠæ°—ã«å…¥ã‚Šã®ã¿å‰Šé™¤å¯èƒ½
CREATE POLICY "Users can delete their own favorites"
ON favorites
FOR DELETE
USING (auth.uid() = user_id);
```

**åŠ¹æœ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ãŠæ°—ã«å…¥ã‚Šã‚’é–²è¦§ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ããªã„
- èªè¨¼ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã‹ã‚‰ä¿è­·ã•ã‚Œã‚‹

---

## âœ… èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Supabase Auth

- **å®Ÿè£…**: `lib/supabase/auth.ts`
- **èªè¨¼æ–¹æ³•**: Email + Password
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: Supabase AuthãŒè‡ªå‹•ç®¡ç†

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

1. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æš—å·åŒ–**: SupabaseãŒè‡ªå‹•çš„ã«æš—å·åŒ–
2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³**: HTTPOnlyã‚¯ãƒƒã‚­ãƒ¼ã§ç®¡ç†
3. **CSRFä¿è­·**: SupabaseãŒè‡ªå‹•çš„ã«å¯¾ç­–
4. **èªè¨¼ãƒ•ãƒ­ãƒ¼**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼

### æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿è­·

**å®Ÿè£…ç®‡æ‰€**: `app/favorites/page.tsx:38-42`

```typescript
useEffect(() => {
  if (!authLoading && !isAuthenticated) {
    router.push('/auth?redirect=/favorites');
  }
}, [authLoading, isAuthenticated, router]);
```

**åŠ¹æœ**: æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„

---

## âœ… APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Next.js API Routes

ç¾åœ¨ã€API Routes (`app/api/*`)ã¯æœªå®Ÿè£…ã§ã™ãŒã€å°†æ¥çš„ã«å®Ÿè£…ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒå¿…è¦ã§ã™ï¼š

#### æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

1. **èªè¨¼ãƒã‚§ãƒƒã‚¯**
```typescript
export async function POST(request: Request) {
  const supabase = createServerSupabaseClient();
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    return new Response('Unauthorized', { status: 401 });
  }

  // ...å‡¦ç†
}
```

2. **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**
```typescript
import { z } from 'zod';

const schema = z.object({
  ingredients: z.array(z.string()).min(1).max(10),
});

const result = schema.safeParse(body);
if (!result.success) {
  return new Response('Invalid input', { status: 400 });
}
```

3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**
```typescript
// Vercel Edge Middleware ã¾ãŸã¯ upstash/ratelimit ã‚’ä½¿ç”¨
```

---

## âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### XSS (ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°) å¯¾ç­–

- **Reactã®è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**: ReactãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- **dangerouslySetInnerHTML**: ä½¿ç”¨ã—ã¦ã„ãªã„ âœ…
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®æ¤œè¨¼**: `components/features/search/IngredientInput.tsx`ã§å®Ÿè£…

### CSRF (ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª) å¯¾ç­–

- **SameSite Cookie**: SupabaseãŒè‡ªå‹•è¨­å®š
- **Origin ãƒã‚§ãƒƒã‚¯**: Next.jsãŒè‡ªå‹•å®Ÿè¡Œ

### Content Security Policy (CSP)

**ç¾çŠ¶**: æœªå®Ÿè£…ï¼ˆä»Šå¾Œã®æ”¹å–„é …ç›®ï¼‰

**æ¨å¥¨è¨­å®š** (`next.config.js`):
```javascript
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' data: https:",
      "font-src 'self' data:",
      "connect-src 'self' https://*.supabase.co https://generativelanguage.googleapis.com https://api.spoonacular.com",
    ].join('; ')
  }
];
```

---

## âš ï¸ æ—¢çŸ¥ã®åˆ¶é™äº‹é …ã¨æ”¹å–„ç‚¹

### 1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**ç¾çŠ¶**: æœªå®Ÿè£…

**ãƒªã‚¹ã‚¯**: DoSæ”»æ’ƒã€APIã‚­ãƒ¼ä¹±ç”¨

**å¯¾ç­–**:
- Vercel Edge Middlewareã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…
- Upstash Redisã‚’ä½¿ç”¨ã—ãŸãƒ¬ãƒ¼ãƒˆåˆ¶é™

### 2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**ç¾çŠ¶**: è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚‹

**ãƒªã‚¹ã‚¯**: å†…éƒ¨æƒ…å ±ã®æ¼æ´©

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯æ±ç”¨çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
- è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã¯ãƒ­ã‚°ã«è¨˜éŒ²

### 3. Content Security Policy

**ç¾çŠ¶**: æœªå®Ÿè£…

**ãƒªã‚¹ã‚¯**: XSSæ”»æ’ƒã®å½±éŸ¿ç¯„å›²ãŒåºƒã„

**å¯¾ç­–**: ä¸Šè¨˜ã®æ¨å¥¨è¨­å®šã‚’å®Ÿè£…

### 4. HTTPSã®å¼·åˆ¶

**ç¾çŠ¶**: VercelãŒè‡ªå‹•çš„ã«HTTPSã‚’å¼·åˆ¶

**ç¢ºèªæ–¹æ³•**: Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèª

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

### å®šæœŸçš„ãªç¢ºèªé …ç›®

#### æ¯æœˆ
- [ ] ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ (`npm audit`)
- [ ] ç’°å¢ƒå¤‰æ•°ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®ç¢ºèª

#### å››åŠæœŸã”ã¨
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨
- [ ] RLSãƒãƒªã‚·ãƒ¼ã®è¦‹ç›´ã—
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª

#### å¹´æ¬¡
- [ ] ç¬¬ä¸‰è€…ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] ç½å®³å¾©æ—§è¨ˆç”»ã®ç¢ºèª

---

## ğŸ›¡ï¸ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®æ‰‹é †

1. **å³åº§ã®å¯¾å¿œ**
   - å½±éŸ¿ã‚’å—ã‘ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸€æ™‚åœæ­¢
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ä¿å­˜
   - é–¢ä¿‚è€…ã«é€šçŸ¥

2. **èª¿æŸ»**
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®åŸå› ã‚’ç‰¹å®š
   - å½±éŸ¿ç¯„å›²ã‚’èª¿æŸ»
   - ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã®æœ‰ç„¡ã‚’ç¢ºèª

3. **å¾©æ—§**
   - è„†å¼±æ€§ã‚’ä¿®æ­£
   - ç’°å¢ƒå¤‰æ•°ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
   - ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†é–‹

4. **äº‹å¾Œå¯¾å¿œ**
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
   - å†ç™ºé˜²æ­¢ç­–ã‚’å®Ÿæ–½
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆå¿…è¦ãªå ´åˆï¼‰

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰](https://nextjs.org/docs/going-to-production#security)
- [Supabase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs/guides/platform/security)
- [Vercel ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://vercel.com/docs/security)

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ7æ—¥
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ7æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025å¹´12æœˆ1æ—¥
